/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{analytics as e}from"../common/analytics.js";import{Proxy as r}from"./proxy.js";import{JUMP_URL_STATUS as t}from"./constant.js";import{dcLocalStorage as o,dcSessionStorage as s}from"../common/local-storage.js";import{acroweb2pdf as a}from"./acro-web2pdf.js";import{viewerModuleUtils as i}from"./viewer-module-utils.js";import{communicate as u}from"./communicate.js";import{SETTINGS as l}from"./settings.js";import{floodgate as m}from"./floodgate.js";let n=null;n||(n=new function(){this.proxy=r.proxy.bind(this),this.userDetails={},this.updateUserDetails=()=>(this.userDetails={},new Promise((e=>{a.getUserInfoFromAcrobat((r=>{this.userDetails=r,o.setItem("acrobatUserDetailsFetchTimestamp",Date.now()),e()}))}))),this.getUserInfoFromAcrobat=async(e,r,t)=>{const s=await i.checkFeatureEnable({flagName:"dc-cv-adobe-yolo",storageKey:"adobeYoloEnable"});if(!(o.getItem("isAcrobat")&&s&&l.ADOBE_YOLO_ENABLED)||o.getWithTTL("adobe-yolo-freeze"))return t({});{const e=o.getItem("acrobatUserDetailsFetchTimestamp");let r;try{const e=m.getFeatureMeta("dc-cv-adobe-yolo"),t=JSON.parse(e);t&&t.cachingTimeInHours&&(r=t.cachingTimeInHours)}catch(e){r=l.ADOBE_YOLO_CACHING_TIME_IN_HOURS}const s=60*r*60*1e3;if(e&&(new Date).getTime()-e<s)return t(this.userDetails);await this.updateUserDetails(),t(this.userDetails)}},this.setFailureCookie=()=>{o.removeItem("adobe-yolo-failure"),o.setWithTTL("adobe-yolo-freeze","true",6048e5)},this.launchJumpUrl=(r,i,u)=>{const l=this.userDetails.userGuid;a.launchJumpUrl(l,(a=>{if(!a||!a.errorCode)return o.removeItem("adobe-yolo-failure"),e.event(e.e.ADOBE_YOLO_JUMP_SUCCESS,{SOURCE:r.source}),u&&u({result:t.SUCCESS});switch(s.removeItem("adobeYoloTabsInfo"),a.errorCode){case"1":return this.userDetails={},e.event(e.e.USER_SIGNED_OUT_ADOBE_YOLO,{SOURCE:r.source}),u&&u({result:t.SIGNED_OUT});case"2":o.removeItem("adobe-yolo-failure"),e.event(e.e.STALE_USER_ADOBE_YOLO,{SOURCE:r.source});const{userName:s,userEmail:i,profileImage:l,userGuid:m}=a;return this.userDetails={userName:s,userEmail:i,profileImage:l,userGuid:m},u&&u({result:t.STALE_USER,userDetails:this.userDetails});case"3":return this.setFailureCookie(),e.event(e.e.SANITY_FAILED_ADOBE_YOLO,{SOURCE:r.source}),u&&u({result:t.FREEZE_YOLO,freeze_reason:t.SANITY_FAILURE});case"4":return e.event(e.e.ADOBE_YOLO_JUMP_TIMED_OUT,{SOURCE:r.source}),o.getItem("adobe-yolo-failure")?(e.event(e.e.ADOBE_YOLO_JUMP_FREEZE,{SOURCE:r.source}),this.setFailureCookie(),u&&u({result:t.FREEZE_YOLO,freeze_reason:t.TIMED_OUT})):(o.setItem("adobe-yolo-failure","true"),u&&u({result:t.ERROR,freeze_reason:t.TIMED_OUT}));default:return e.event(e.e.ADOBE_YOLO_JUMP_ERROR,{SOURCE:r.source}),o.getItem("adobe-yolo-failure")?(e.event(e.e.ADOBE_YOLO_JUMP_FREEZE,{SOURCE:r.source}),this.setFailureCookie(),u&&u({result:t.FREEZE_YOLO,freeze_reason:t.ERROR})):(o.setItem("adobe-yolo-failure","true"),u&&u({result:t.ERROR,freeze_reason:t.ERROR}))}}))}},u.registerModule("acrobatUserDetails",n),u.registerHandlers({getUserInfoFromAcrobat:n.proxy(n.getUserInfoFromAcrobat),launchJumpUrl:n.proxy(n.launchJumpUrl)}));export const userDetailsAcrobat=n;